name: Deploy to dominai.io

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Check out
      uses: actions/checkout@v3
    
    - name: Install opam
      run: sudo apt-get install -y libev-dev opam
    
    - name: Opam init
      run: opam init --bare

    - name: Install Ocaml 4.14.0
      run: opam switch create 4.14.0

    - name: Install opam dependencies
      run: opam install -y . --deps-only 

    - name: Build server
      run: |
        eval $(opam env)
        dune build src/main.exe
  
  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Check out
      uses: actions/checkout@v3

    - name: Deploy to server
      uses: easingthemes/ssh-deploy@v2.2.11
      env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          REMOTE_HOST: 3.225.230.184
          REMOTE_USER: ubuntu